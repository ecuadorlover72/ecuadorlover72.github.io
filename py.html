<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Python Runner — Multi-Tab + Projects + Collaboration</title>

  <style>
    :root{--bg:#0f1720;--card:#0b1220;--muted:#94a3b8;--accent:#0ea5a3;--danger:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui}
    body{background:linear-gradient(180deg,#071029 0%, #071827 60%);color:#dbe7f0}

    .app{display:grid;grid-template-columns:1fr 400px;gap:20px;padding:28px;min-height:100vh}
    .panel{background:rgba(255,255,255,0.02);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}

    #tabBar{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;user-select:none}
    .tab{
      padding:6px 10px;border-radius:6px;
      background:#0b1220;border:1px solid rgba(255,255,255,0.08);
      cursor:pointer;font-size:13px;display:flex;align-items:center;
    }
    .tab.active{background:var(--accent);color:#072024;font-weight:700}
    .tab .close{margin-left:6px;cursor:pointer;font-weight:bold}
    .tab.dragging{opacity:0.4}

    #editor{height:55vh;border-radius:8px;overflow:hidden}

    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#e6f3f6;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
    button.primary{background:linear-gradient(90deg,var(--accent),#06b6d4);color:#072024;border:none}

    .output{height:20vh;overflow:auto;padding:12px;border-radius:8px;background:#050812;border:1px solid rgba(255,255,255,0.02);font-family:monospace;font-size:13px;white-space:pre-wrap}

    #notesPanel{width:100%;min-height:150px;display:none;background:#050812;color:white}
    #historyPanel{width:100%;min-height:100px;display:none;overflow:auto;background:#061226;padding:6px;border-radius:6px}

    #turtleCanvas{display:block;margin-top:10px}

    .small{font-size:12px;color:var(--muted)}
  </style>

</head>
<body>

<div class="app">

<div class="panel">

<header>
  <div>
    <h1>Python Runner</h1>
    <p class="small">Multi-tab editor with Pyodide runtime + Projects + Collaboration</p>
  </div>
  <div class="small">Runtime: <span id="py-status">Loading…</span></div>
</header>

<!-- PROJECT SELECTION -->
<select id="projectSelect"></select>
<button id="newProjectBtn">+ New Project</button>

<!-- TABS -->
<div id="tabBar">
  <div class="tab active" data-id="0" draggable="true">Tab 1</div>
  <div class="tab" id="newTabBtn">+ New</div>
</div>

<div class="controls">
  <button id="runBtn" class="primary">Run</button>
  <button id="stopBtn">Stop</button>
  <button id="downloadBtn">Download</button>
  <button id="formatBtn">Format</button>
  <button id="importPyBtn">Import Package</button>
  <button id="importFileBtn">Import .py</button>
  <button id="notesBtn" class="primary">Notes</button>
  <button id="historyBtn">History</button>
  <button id="clearOutputBtn">Clear Output</button>
  <input type="file" id="fileInput" accept=".py" style="display:none">
</div>

<div id="editor"></div>

</div>

<!-- SIDE PANEL -->
<aside class="panel">
  <h3>Console Output</h3>
  <div id="output" class="output"></div>

  <h3>Turtle Canvas</h3>
  <canvas id="turtleCanvas" width="400" height="300" style="background:#050812;border:1px solid rgba(255,255,255,0.02);border-radius:8px"></canvas>

  <h3>Notes</h3>
  <textarea id="notesPanel" class="output"></textarea>

  <h3>History</h3>
  <div id="historyPanel"></div>
</aside>

</div>

<!-- JS + ACE + PYODIDE -->
<script src="https://cdn.jsdelivr.net/gh/ajaxorg/ace-builds@1.4.14/src-min-noconflict/ace.js"></script>
<script src="https://cdn.jsdelivr.net/gh/ajaxorg/ace-builds@1.4.14/src-min-noconflict/ext-language_tools.js"></script>
<script src="https://cdn.jsdelivr.net/gh/pyodide/pyodide/v0.24.1/full/pyodide.js"></script>

<script>
/* ==========================
   ACE EDITOR INIT
=========================== */
const editor = ace.edit("editor", {
  mode: "ace/mode/python",
  theme: "ace/theme/monokai"
});
editor.setOptions({
  fontSize: 14,
  wrap: true,
  enableBasicAutocompletion: true,
  enableSnippets: true,
  enableLiveAutocompletion: true
});
editor.session.setUseWorker(false);

/* ==========================
   PROJECT + TAB SYSTEM
=========================== */
let projects = [
  { name: "Default Project", tabs: [{ id:0, name:"Tab 1", code:"# Welcome to Tab 1\nprint('Hello!')"}] }
];
let activeProject = 0;
let activeTab = 0;

const tabBar = document.getElementById("tabBar");
const newTabBtn = document.getElementById("newTabBtn");
const projectSelect = document.getElementById("projectSelect");
const newProjectBtn = document.getElementById("newProjectBtn");

function saveCurrentTab() {
  const tab = projects[activeProject].tabs.find(t=>t.id===activeTab);
  if(tab) tab.code = editor.getValue();
}

function refreshProjects() {
  projectSelect.innerHTML = "";
  projects.forEach((p,i)=>{
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = p.name;
    projectSelect.appendChild(opt);
  });
  projectSelect.value = activeProject;
}

function switchProject(idx) {
  saveCurrentTab();
  activeProject = idx;
  if(projects[idx].tabs.length === 0) {
    projects[idx].tabs.push({ id:Date.now(), name:"Tab 1", code:""});
  }
  activeTab = projects[idx].tabs[0].id;
  editor.setValue(projects[idx].tabs[0].code,-1);
  refreshTabs();
  refreshProjects();
}

function refreshTabs() {
  [...tabBar.querySelectorAll(".tab")].forEach(t=> t.id!=="newTabBtn" && t.remove());
  const tabs = projects[activeProject].tabs;

  tabs.forEach(t => {
    const el = document.createElement("div");
    el.className = "tab" + (t.id===activeTab?" active":"");
    el.dataset.id = t.id;
    el.draggable = true;
    el.textContent = t.name;

    const close = document.createElement("span");
    close.textContent = " ×";
    close.className = "close";
    close.onclick = e=>{
      e.stopPropagation();
      closeTab(t.id);
    };
    el.appendChild(close);

    el.ondblclick = ()=>renameTab(t.id);

    el.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", t.id);
      el.classList.add("dragging");
    });
    el.addEventListener("dragend", ()=> el.classList.remove("dragging"));

    el.addEventListener("click", ()=>switchTab(t.id));

    tabBar.insertBefore(el,newTabBtn);
  });
}

function switchTab(id) {
  saveCurrentTab();
  activeTab = id;
  const tab = projects[activeProject].tabs.find(t=>t.id===id);
  if(tab) editor.setValue(tab.code,-1);
  refreshTabs();
}

function closeTab(id) {
  saveCurrentTab();
  let tabs = projects[activeProject].tabs;
  projects[activeProject].tabs = tabs.filter(t=>t.id!==id);
  if(projects[activeProject].tabs.length===0){
    projects[activeProject].tabs.push({id:Date.now(),name:"Tab 1",code:""});
  }
  activeTab = projects[activeProject].tabs[0].id;
  editor.setValue(projects[activeProject].tabs[0].code,-1);
  refreshTabs();
}

function renameTab(id){
  let tab = projects[activeProject].tabs.find(t=>t.id===id);
  let newName = prompt("Rename tab:", tab.name);
  if(newName) { tab.name = newName; refreshTabs(); }
}

newTabBtn.onclick = ()=>{
  saveCurrentTab();
  const id = Date.now();
  projects[activeProject].tabs.push({id, name:"Tab "+(projects[activeProject].tabs.length+1), code:"# New tab\n"});
  activeTab = id;
  editor.setValue("",-1);
  refreshTabs();
}

projectSelect.onchange = e=>switchProject(Number(e.target.value));

newProjectBtn.onclick = ()=>{
  const name = prompt("Project name:");
  if(name){
    projects.push({name, tabs:[]});
    switchProject(projects.length-1);
  }
}

refreshProjects();
refreshTabs();

/* ==========================
   PYODIDE + TURTLE + OUTPUT
=========================== */
let pyodide = null;
let running = false;
const outputEl = document.getElementById("output");
const statusEl = document.getElementById("py-status");

async function initPyodide() {
  try {
    statusEl.textContent = "Loading…";
    pyodide = await loadPyodide({indexURL:"https://cdn.jsdelivr.net/gh/pyodide/pyodide/v0.24.1/full/"});
    await pyodide.loadPackage("micropip");
    await pyodide.runPythonAsync(`import js\nfrom pyodide.ffi import create_proxy`);
    await pyodide.runPythonAsync(`
import turtle
from js import document
canvas = document.getElementById("turtleCanvas")
screen = turtle.TurtleScreen(canvas)
t = turtle.RawTurtle(screen)
screen.tracer(0)
def run_turtle_code(code):
    exec(code)
    screen.update()
`);
    statusEl.textContent = "Ready";
  } catch(err) {
    console.error("Pyodide init failed", err);
    statusEl.textContent = "Error loading Pyodide";
  }
}
initPyodide();

/* ==========================
   ENHANCED OUTPUT STREAMS
=========================== */
function createOutputStreams(){
  const write = (s,type="stdout")=>{
    let color = "white";
    if(type==="stderr" || s.toLowerCase().includes("error") || s.toLowerCase().includes("traceback")) color="red";
    else if(type==="warn") color="yellow";
    let display = s.length>200 ? `<details><summary>Output...</summary>${s}</details>` : s;
    outputEl.innerHTML += `<span style="color:${color}">${display}</span>\n`;
    outputEl.scrollTop = outputEl.scrollHeight;
  };
  return {write};
}

/* ==========================
   RUN CODE
=========================== */
document.getElementById("runBtn").onclick = async ()=>{
  if(!pyodide){ alert("Pyodide not ready yet!"); return; }
  saveCurrentTab();
  outputEl.innerHTML = "";
  statusEl.textContent="Running…";
  const code = editor.getValue();
  const streams = createOutputStreams();
  const redirect = `
import sys
from js import console
class _W:
    def write(self,s): console.log(s)
    def flush(self): pass
sys.stdout = _W()
sys.stderr = _W()
`;
  try{
    if(code.includes("turtle")){
      await pyodide.runPythonAsync(`run_turtle_code('''${code.replace(/'/g,"\\'")}''')`);
    } else {
      await pyodide.runPythonAsync(redirect+"\n"+code);
    }
  } catch(err){
    streams.write(err.toString(),"stderr");
  }
  statusEl.textContent="Ready";
};

/* STOP BUTTON */
document.getElementById("stopBtn").onclick = ()=>{outputEl.innerHTML += "\n*** Interrupt requested — refresh page to force stop ***\n";};

/* DOWNLOAD */
document.getElementById("downloadBtn").onclick = ()=>{
  saveCurrentTab();
  const tab = projects[activeProject].tabs.find(t=>t.id===activeTab);
  const blob = new Blob([tab.code],{type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = tab.name+".py";
  a.click();
};

/* FORMAT */
document.getElementById("formatBtn").onclick = async ()=>{
  const code = editor.getValue();
  try{
    const formatted = await pyodide.runPythonAsync(`
import ast, astor
tree = ast.parse("""${code.replace(/"/g,'\\"')}""")
astor.to_source(tree)
`);
    editor.setValue(formatted,-1);
  } catch { alert("Formatting failed."); }
};

/* IMPORT PACKAGE */
document.getElementById("importPyBtn").onclick = async ()=>{
  let pkg = prompt("Enter module name:");
  if(pkg){
    try{
      await pyodide.loadPackage(pkg);
      outputEl.innerHTML += `\nImported: ${pkg}\n`;
    } catch{
      outputEl.innerHTML += `\nFailed: ${pkg}\n`;
    }
  }
};

/* IMPORT FILE */
document.getElementById("importFileBtn").onclick = ()=>document.getElementById("fileInput").click();
document.getElementById("fileInput").onchange = async e=>{
  const f = e.target.files[0];
  if(f) editor.setValue(await f.text(),-1);
};

/* NOTES */
document.getElementById("notesBtn").onclick = ()=>{
  const n = document.getElementById("notesPanel");
  n.style.display = n.style.display==="none"?"block":"none";
};

/* HISTORY */
let history = [];
document.getElementById("historyBtn").onclick = ()=>{
  const hp = document.getElementById("historyPanel");
  hp.style.display = hp.style.display==="none"?"block":"none";
};
function addHistory(code){
  const ts = new Date().toLocaleTimeString();
  history.push({ts,code});
  const div = document.createElement("div");
  div.textContent = `[${ts}] ${code.slice(0,40)}...`;
  div.style.cursor="pointer";
  div.onclick = ()=>editor.setValue(code,-1);
  document.getElementById("historyPanel").prepend(div);
}

/* CLEAR OUTPUT */
document.getElementById("clearOutputBtn").onclick = ()=>{outputEl.innerHTML="";};

/* ==========================
   LIVE COLLABORATION (basic)
=========================== */
let ws = new WebSocket("wss://echo.websocket.events");
ws.onopen = ()=>console.log("Collab connected");
ws.onmessage = e=>{
  try{
    const msg = JSON.parse(e.data);
    if(msg.type==="code" && msg.tabId===activeTab){
      editor.setValue(msg.code,-1);
    }
  } catch{}
};
editor.on("change", ()=>{
  if(ws.readyState===1){
    ws.send(JSON.stringify({type:"code",tabId:activeTab,code:editor.getValue()}));
  }
});
</script>

</body>
</html>

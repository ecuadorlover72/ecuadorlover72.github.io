<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Esports Country Guessing â€” Ultimate Edition</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
/* ------------------------------------------------------
   GLOBAL UI â€” E-SPORTS THEME
------------------------------------------------------ */
html, body {
    margin: 0;
    height: 100%;
    font-family: "Orbitron", sans-serif;
    background: #050008;
    color: #fff;
    overflow: hidden;
}

#map {
    height: 100%;
    filter: brightness(0.9) contrast(1.1);
}

/* ------------------------------------------------------
   TOP BAR (MODES + SCORE)
------------------------------------------------------ */
#top-bar {
    position: fixed;
    top: 0;
    width: 100%;
    height: 70px;
    display: flex;
    align-items: center;
    padding: 0 20px;
    background: rgba(10,0,20,0.8);
    border-bottom: 2px solid #ff00ff;
    z-index: 1000;
    backdrop-filter: blur(10px);
}

.mode-btn {
    margin-right: 12px;
    padding: 10px 18px;
    background: #120020;
    border: 2px solid #ff00ff;
    border-radius: 8px;
    color: #ff00ff;
    font-size: 14px;
    cursor: pointer;
    transition: 0.2s;
}
.mode-btn:hover {
    background: #ff00ff;
    color: #000;
}

#score-display {
    margin-left: auto;
    font-size: 18px;
    font-weight: bold;
    color: #00eaff;
}

/* ------------------------------------------------------
   INPUT
------------------------------------------------------ */
#guess-box {
    position: fixed;
    bottom: 160px;
    left: 50%;
    transform: translateX(-50%);
    width: 350px;
    background: rgba(20,0,30,0.9);
    border: 2px solid #ff00ff;
    padding: 15px;
    font-size: 18px;
    color: #fff;
    border-radius: 12px;
    box-shadow: 0 0 16px #ff00ff;
    outline: none;
    z-index: 1000;
}

#guess-box:focus {
    box-shadow: 0 0 25px #ff00ff;
}

/* ------------------------------------------------------
   HUD PANEL
------------------------------------------------------ */
#hud {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 130px;
    background: rgba(10,0,25,0.85);
    border-top: 2px solid #ff00ff;
    display: flex;
    justify-content: space-around;
    align-items: center;
    backdrop-filter: blur(10px);
    z-index: 1000;
}

.hud-item {
    text-align: center;
    font-size: 15px;
    color: #00eaff;
    font-weight: bold;
}

/* XP bar */
#xp-wrap {
    width: 140px;
    height: 14px;
    background: #220030;
    border-radius: 6px;
    margin-top: 8px;
}
#xp-fill {
    width: 0%;
    height: 100%;
    background: #ff00ff;
    border-radius: 6px;
}

/* ------------------------------------------------------
   ACHIEVEMENT POPUP
------------------------------------------------------ */
#achievement {
    position: fixed;
    top: 90px;
    right: 20px;
    min-width: 240px;
    padding: 15px 18px;
    border-left: 4px solid #ff00ff;
    background: rgba(40,0,60,0.95);
    font-size: 14px;
    font-weight: bold;
    color: #fff;
    border-radius: 8px;
    opacity: 0;
    transform: translateX(150%);
    z-index: 2000;
}

#achievement.show {
    animation: slideIn 0.7s forwards, fadeOut 0.7s 2.4s forwards;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(150%); }
    to   { opacity: 1; transform: translateX(0); }
}
@keyframes fadeOut {
    from { opacity: 1; }
    to   { opacity: 0; }
}

/* ------------------------------------------------------
   COUNTRY HIGHLIGHT ANIMATION
------------------------------------------------------ */
@keyframes flash {
    0% { fill: #ff00ff; }
    50% { fill: #00eaff; }
    100% { fill: #28a745; }
}

/* ------------------------------------------------------ */
</style>
</head>
<body>

<div id="map"></div>

<!-- TOP BAR -->
<div id="top-bar">
    <div class="mode-btn" onclick="setMode('classic')">Classic</div>
    <div class="mode-btn" onclick="setMode('time')">Time Attack</div>
    <div class="mode-btn" onclick="setMode('streak')">Streak</div>
    <div class="mode-btn" onclick="setMode('random')">Random Country</div>

    <div id="score-display">0 / 0</div>
</div>

<!-- INPUT -->
<input id="guess-box" placeholder="Type a country...">

<!-- HUD -->
<div id="hud">
    <div class="hud-item">Correct<br><span id="hud-correct">0</span></div>
    <div class="hud-item">Level<br><span id="hud-level">1</span>
        <div id="xp-wrap"><div id="xp-fill"></div></div>
    </div>
    <div class="hud-item">Time<br><span id="hud-time">00:00</span></div>
</div>

<div id="achievement"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ------------------------------------------------------
   MAP SETUP
------------------------------------------------------ */
const map = L.map("map").setView([20, 0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 5 }).addTo(map);

let countryLayers = {};
let guessed = new Set();
let total = 0;

/* ------------------------------------------------------
   GAME MODES
------------------------------------------------------ */
let currentMode = "classic";
let timerInterval = null;
let timerStart = null;
let streakActive = true;
let randomTarget = null;

function setMode(mode) {
    currentMode = mode;

    resetGame();

    if (mode === "time") startTimerCountdown(180);
    if (mode === "random") chooseRandomCountry();

    document.getElementById("guess-box").placeholder =
        mode === "random" ? "Type the shown country..." : "Type a country...";
}

/* ------------------------------------------------------
   TIMER
------------------------------------------------------ */
function startTimer() {
    timerStart = Date.now();
    timerInterval = setInterval(() => {
        let ms = Date.now() - timerStart;
        let m = String(Math.floor(ms / 60000)).padStart(2, "0");
        let s = String(Math.floor((ms / 1000) % 60)).padStart(2, "0");
        document.getElementById("hud-time").textContent = `${m}:${s}`;
    }, 1000);
}

function startTimerCountdown(sec) {
    let remaining = sec;
    document.getElementById("hud-time").textContent = formatTime(sec);

    timerInterval = setInterval(() => {
        remaining--;
        document.getElementById("hud-time").textContent = formatTime(remaining);

        if (remaining <= 0) endGame();
    }, 1000);
}

function formatTime(s) {
    return String(Math.floor(s/60)).padStart(2,"0") + ":" + String(s%60).padStart(2,"0");
}

/* ------------------------------------------------------
   LOADING COUNTRY SHAPES
------------------------------------------------------ */
fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
.then(r => r.json())
.then(data => {
    total = data.features.length;
    document.getElementById("score-display").textContent = `0 / ${total}`;

    L.geoJSON(data, {
        style: { color:"#333", weight:0.7, fillColor:"#111", fillOpacity:0.55 },
        onEachFeature: (f,layer) => {
            const name = normalize(f.properties.name);
            countryLayers[name] = layer;
        }
    }).addTo(map);
});

/* ------------------------------------------------------
   INPUT HANDLING
------------------------------------------------------ */
const input = document.getElementById("guess-box");

input.addEventListener("keyup", () => {
    let val = normalize(input.value);
    if (!val) return;

    // Time mode - start timer on first guess
    if (currentMode !== "time" && !timerInterval) startTimer();

    // Mode logic
    if (currentMode === "random") {
        if (val === randomTarget) correctGuess(val);
        return;
    }

    // Classic / Streak / Time Attack
    if (countryLayers[val] && !guessed.has(val)) {
        correctGuess(val);
    } else if (currentMode === "streak") {
        endGame("Incorrect guess â€” streak ended!");
    }
});

/* ------------------------------------------------------
   CORRECT GUESS
------------------------------------------------------ */
let xp = 0, level = 1;

function correctGuess(name) {
    guessed.add(name);
    highlightCountry(name);
    updateScore();
    gainXP(10);
    showAchievementCheck();
    input.value = "";

    if (currentMode === "random") chooseRandomCountry();
}

/* ------------------------------------------------------
   HIGHLIGHTING
------------------------------------------------------ */
function highlightCountry(name) {
    const layer = countryLayers[name];
    const el = layer.getElement();
    el.style.animation = "flash 1s";
    setTimeout(() => el.style.animation = "", 1000);

    layer.setStyle({ fillColor:"#28a745", fillOpacity:0.9 });
}

/* ------------------------------------------------------
   XP SYSTEM
------------------------------------------------------ */
function gainXP(n) {
    xp += n;
    if (xp >= 100) {
        xp -= 100;
        level++;
        document.getElementById("hud-level").textContent = level;
    }
    document.getElementById("xp-fill").style.width = xp + "%";
}

/* ------------------------------------------------------
   RANDOM COUNTRY MODE
------------------------------------------------------ */
function chooseRandomCountry() {
    const names = Object.keys(countryLayers);
    randomTarget = names[Math.floor(Math.random() * names.length)];
    // Flash target
    highlightCountry(randomTarget);
}

/* ------------------------------------------------------
   ACHIEVEMENTS
------------------------------------------------------ */
const cheevos = [
    { name:"First Blood", req:1, done:false },
    { name:"10 Unlocked", req:10, done:false },
    { name:"World Explorer", req:50, done:false },
    { name:"Geo Master", req:100, done:false }
];

function showAchievementCheck() {
    cheevos.forEach(c => {
        if (!c.done && guessed.size >= c.req) {
            c.done = true;
            showAchievement(c.name);
        }
    });
}

function showAchievement(text) {
    const a = document.getElementById("achievement");
    a.textContent = "ðŸ† " + text;
    a.classList.add("show");
    setTimeout(() => a.classList.remove("show"), 3000);
}

/* ------------------------------------------------------
   SCORE UPDATE
------------------------------------------------------ */
function updateScore() {
    const g = guessed.size;
    document.getElementById("hud-correct").textContent = g;
    document.getElementById("score-display").textContent = `${g} / ${total}`;
}

/* ------------------------------------------------------
   NORMALIZE TEXT
------------------------------------------------------ */
function normalize(str) {
    return str.toLowerCase().normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z ]/g,"")
        .trim();
}

/* ------------------------------------------------------
   RESET & END GAME
------------------------------------------------------ */
function resetGame() {
    guessed.clear();
    xp = 0;
    level = 1;

    document.getElementById("hud-level").textContent = 1;
    document.getElementById("xp-fill").style.width = "0%";
    document.getElementById("hud-correct").textContent = 0;
    document.getElementById("score-display").textContent = `0 / ${total}`;

    // Reset map colors
    for (let c in countryLayers) {
        countryLayers[c].setStyle({ fillColor:"#111", fillOpacity:0.55 });
    }

    // Reset timer
    clearInterval(timerInterval);
    timerInterval = null;
    document.getElementById("hud-time").textContent = "00:00";
}

function endGame(msg="Time's up!") {
    clearInterval(timerInterval);
    alert(msg);
    resetGame();
}

</script>

</body>
</html>

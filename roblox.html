<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Roblox Account Lookup</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  input, button { padding: 5px; margin: 5px 0; }
  .card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
  .tag { background: #eee; padding: 2px 4px; border-radius: 3px; font-size: 0.9em; }
  #suggestionsList { border: 1px solid #ccc; display:none; position:absolute; background:#fff; z-index:10; max-width:300px; }
  .suggestion-item { padding: 5px; cursor:pointer; }
  .suggestion-item:hover { background:#f0f0f0; }
  #popup { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; }
  #popupContent { background:#fff; padding:20px; max-height:80%; overflow:auto; border-radius:5px; }
</style>
</head>
<body>

<h2>Roblox Account Lookup</h2>
<input id="rbxUser" placeholder="Enter username">
<button id="rbxFetch">Fetch Account Data</button>
<div id="suggestionsList"></div>
<div id="rbxResults"></div>

<div id="popup">
  <div id="popupContent"></div>
</div>

<script>
/********** Utility Functions **********/
async function fetchJson(url, options={}) {
  const res = await fetch(url, options);
  if (!res.ok) throw new Error('Error fetching data.');
  return res.json();
}

async function tryMulti(urls, options={}) {
  for (const url of urls) {
    try { return await fetchJson(url, options); } catch {}
  }
  throw new Error('All endpoints failed.');
}

function proxyWrap(url) {
  return `https://corsproxy.io/?${encodeURIComponent(url)}`;
}

function setLoading(flag) {
  console.log('Loading:', flag);
}

function showPopup(title, list, onClickName) {
  const popup = document.getElementById('popup');
  const content = document.getElementById('popupContent');
  content.innerHTML = `<h3>${title}</h3><ul>${list.map(i=>`<li>${onClickName ? `<a href="#" onclick="renderProfile('${i}');closePopup();return false;">${i}</a>`:i}</li>`).join('')}</ul><button onclick="closePopup()">Close</button>`;
  popup.style.display='flex';
}

function closePopup() {
  document.getElementById('popup').style.display='none';
}

/********** Roblox API Endpoints **********/
const usernameEndpoints = [
  'https://users.roproxy.com/v1/usernames/users',
  'https://users.rprxy.xyz/v1/usernames/users',
  proxyWrap('https://users.roblox.com/v1/usernames/users')
];

async function lookupUser(name){
  const payload = {usernames:[name],excludeBannedUsers:false};
  for(const url of usernameEndpoints){
    try{
      const data = await fetchJson(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(data?.data?.length) return data.data[0];
    }catch{}
  }
  throw new Error('Unable to reach Roblox user services.');
}

async function getUserProfile(id){
  return await tryMulti([
    `https://users.roproxy.com/v1/users/${id}`,
    `https://users.rprxy.xyz/v1/users/${id}`,
    proxyWrap(`https://users.roblox.com/v1/users/${id}`)
  ]);
}

/********** UI Logic **********/
const rbxInput = document.getElementById('rbxUser');
const rbxResults = document.getElementById('rbxResults');
const suggList = document.getElementById('suggestionsList');
let suggTimer=null;

rbxInput.oninput = ()=>{
  const q = rbxInput.value.trim();
  if(suggTimer) clearTimeout(suggTimer);
  if(q.length<3){ suggList.style.display='none'; return; }
  suggTimer = setTimeout(()=>searchSuggest(q),220);
};

async function searchSuggest(q){
  try{
    const data = await fetchJson(proxyWrap(`https://users.roblox.com/v1/users/search?keyword=${encodeURIComponent(q)}&limit=10`));
    if(!data?.data?.length){suggList.style.display='none';return;}
    suggList.innerHTML = data.data.map(u=>`<div class="suggestion-item" data-u="${u.name}">${u.displayName} (@${u.name})</div>`).join('');
    suggList.style.display='block';
    suggList.querySelectorAll('.suggestion-item').forEach(el=>{
      el.onclick = ()=>{rbxInput.value=el.dataset.u;suggList.style.display='none';renderProfile(el.dataset.u);};
    });
  }catch{ suggList.style.display='none'; }
}

document.getElementById('rbxFetch').onclick = ()=>renderProfile(rbxInput.value.trim());

async function renderProfile(username){
  if(!username) return;
  rbxResults.innerHTML = `<div class="card">Loading profile for <b>${username}</b>...</div>`;
  setLoading(true);
  try{
    const user = await lookupUser(username);
    const id = user.id;
    const profile = await getUserProfile(id);

    const friends = await tryMulti([
      `https://friends.roproxy.com/v1/users/${id}/friends?limit=200`,
      `https://friends.rprxy.xyz/v1/users/${id}/friends?limit=200`,
      proxyWrap(`https://friends.roblox.com/v1/users/${id}/friends?limit=200`)
    ]);
    const groups = await tryMulti([
      `https://groups.roproxy.com/v2/users/${id}/groups/roles`,
      `https://groups.rprxy.xyz/v2/users/${id}/groups/roles`,
      proxyWrap(`https://groups.roblox.com/v2/users/${id}/groups/roles`)
    ]);
    const badges = await tryMulti([
      `https://badges.roproxy.com/v1/users/${id}/badges?limit=100`,
      `https://badges.rprxy.xyz/v1/users/${id}/badges?limit=100`,
      proxyWrap(`https://badges.roblox.com/v1/users/${id}/badges?limit=100`)
    ]);

    const friendsList = (friends?.data||[]).map(f=>f.name);
    const groupsList = (groups?.data||[]).map(g=>`${g.group.name} â€” ${g.role?.name||'Member'}`);
    const badgeList = (badges?.data||[]).map(b=>b.name);

    rbxResults.innerHTML = '';

    function makeCard(title,body,list,onClickName){
      const c = document.createElement('div');
      c.className='card';
      c.innerHTML = `<h3>${title}</h3><p>${body}</p>`;
      if(list && list.length){
        const btn = document.createElement('button');
        btn.textContent='Show All';
        btn.onclick=()=>showPopup(title,list,onClickName);
        c.appendChild(btn);
      }
      rbxResults.appendChild(c);
    }

    makeCard('Profile',`
      <span class="tag">ID: ${id}</span><br>
      <b>${profile.displayName}</b><br>@${profile.name}<br>
      Created: ${profile.created? new Date(profile.created).toLocaleDateString(): 'Unknown'}<br>
      Description: <span class="small">${profile.description || '(none)'}</span>
    `);
    makeCard('Friends',friendsList.slice(0,6).join(', ')||'None',friendsList,name=>renderProfile(name));
    makeCard('Groups',groupsList.slice(0,5).join('<br>')||'None',groupsList,null);
    if(badgeList.length) makeCard('Badges',badgeList.slice(0,5).join(', '),badgeList,null);

  }catch(err){
    rbxResults.innerHTML = `<div class="card"><h3>Error</h3><p>${err.message}</p></div>`;
  }
  setLoading(false);
}
</script>

</body>
</html>

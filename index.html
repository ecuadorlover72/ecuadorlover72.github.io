/* ========== INFINITE OBBY GAME ========== */
function startObby() {
  const canvas = document.getElementById('obby-canvas');
  const ctx = canvas.getContext('2d');
  let player = { x: 50, y: 300, w: 30, h: 30, vy: 0, onGround: false };
  let gravity = 0.6;
  let speed = 4;
  let score = 0;
  let obstacles = [];
  let platforms = [];
  let gameOver = false;

  // Key controls
  let spacePressed = false;
  document.addEventListener('keydown', (e) => {
    if (e.key === ' ' && player.onGround) {
      player.vy = -12;
      player.onGround = false;
    }
  });

  // Reset on switch
  function resetGame() {
    player.x = 50;
    player.y = 300;
    player.vy = 0;
    player.onGround = false;
    obstacles = [];
    score = 0;
    gameOver = false;
  }

  resetGame();

  function spawnObstacle() {
    const height = 20 + Math.random() * 40;
    const y = 380 - height;
    obstacles.push({
      x: 500,
      y,
      w: 20,
      h: height,
    });
  }

  function draw() {
    if (currentGame !== 'obby') return;

    ctx.clearRect(0, 0, 500, 400);

    // Background
    ctx.fillStyle = '#cceeff';
    ctx.fillRect(0, 0, 500, 400);

    // Ground
    ctx.fillStyle = '#444';
    ctx.fillRect(0, 380, 500, 20);

    // Spawn obstacles
    if (Math.random() < 0.02) {
      spawnObstacle();
    }

    // Update and draw obstacles
    ctx.fillStyle = '#222';
    obstacles.forEach((obs) => {
      obs.x -= speed;
      ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
    });

    // Remove off-screen obstacles
    obstacles = obstacles.filter((o) => o.x + o.w > 0);

    // Gravity and movement
    player.vy += gravity;
    player.y += player.vy;
    if (player.y + player.h >= 380) {
      player.y = 380 - player.h;
      player.vy = 0;
      player.onGround = true;
    }

    // Collision check
    obstacles.forEach((obs) => {
      if (
        player.x < obs.x + obs.w &&
        player.x + player.w > obs.x &&
        player.y + player.h > obs.y
      ) {
        gameOver = true;
      }
    });

    // Player
    ctx.fillStyle = gameOver ? 'red' : '#00cc00';
    ctx.fillRect(player.x, player.y, player.w, player.h);

    // Score
    ctx.fillStyle = '#000';
    ctx.font = '20px Arial';
    ctx.fillText(`Score: ${Math.floor(score)}`, 20, 30);
    score += 0.1;

    if (gameOver) {
      ctx.fillStyle = 'black';
      ctx.font = '30px Arial';
      ctx.fillText('ðŸ’€ Game Over!', 150, 200);
      ctx.font = '20px Arial';
      ctx.fillText('Press Space to Restart', 135, 240);
      document.addEventListener('keydown', restartHandler);
      return;
    }

    requestAnimationFrame(draw);
  }

  function restartHandler(e) {
    if (e.key === ' ') {
      document.removeEventListener('keydown', restartHandler);
      resetGame();
      draw();
    }
  }

  draw();
}
